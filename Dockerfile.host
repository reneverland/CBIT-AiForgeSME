# æ„å»ºé˜¶æ®µ
FROM node:18-alpine AS builder

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./

# å®‰è£…ä¾èµ–
RUN npm install

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
RUN npm run build

# ç”Ÿäº§é˜¶æ®µ
FROM nginx:alpine

# ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæºï¼ˆè§£å†³ç½‘ç»œé—®é¢˜ï¼‰
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# å®‰è£…å·¥å…·ï¼ˆcurlç”¨äºå¥åº·æ£€æŸ¥ï¼Œgettextç”¨äºenvsubstï¼‰
RUN apk add --no-cache curl gettext

# å¤åˆ¶æ„å»ºäº§ç‰©åˆ° Nginx
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶ Nginx é…ç½®æ¨¡æ¿
COPY nginx.conf.template /etc/nginx/templates/default.conf.template

# è®¾ç½®é»˜è®¤ç¯å¢ƒå˜é‡ï¼ˆå¯ä»¥è¢«docker-composeè¦†ç›–ï¼‰
ENV BACKEND_API_URL=http://127.0.0.1:5173

# åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼Œä½¿ç”¨envsubstæ›¿æ¢ç¯å¢ƒå˜é‡
RUN echo '#!/bin/sh' > /docker-entrypoint.sh && \
    echo 'echo "ğŸ”§ é…ç½®Nginxåç«¯APIåœ°å€: $BACKEND_API_URL"' >> /docker-entrypoint.sh && \
    echo 'envsubst "\$BACKEND_API_URL" < /etc/nginx/templates/default.conf.template > /etc/nginx/conf.d/default.conf' >> /docker-entrypoint.sh && \
    echo 'echo "âœ… Nginxé…ç½®ç”Ÿæˆå®Œæˆ"' >> /docker-entrypoint.sh && \
    echo 'cat /etc/nginx/conf.d/default.conf' >> /docker-entrypoint.sh && \
    echo 'exec nginx -g "daemon off;"' >> /docker-entrypoint.sh && \
    chmod +x /docker-entrypoint.sh

# å¥åº·æ£€æŸ¥ï¼ˆç»™äºˆæ›´é•¿çš„å¯åŠ¨æ—¶é—´ï¼‰
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:9200/health || exit 1

EXPOSE 9200

CMD ["/docker-entrypoint.sh"]
